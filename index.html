<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeeClock</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for audio alerts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        /* --- CORE FULL-PAGE STYLING --- */
        html, body {
            height: 100%; 
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }

        /* Custom font import for modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- DYNAMIC THEME DEFINITION --- */
        :root {
            /* Default Dark Theme */
            --bg-color: #0d1117;        
            --card-bg: #1f2937;         
            --text-color: #ffffff;      
            --sub-text-color: #9ca3af;  
            --display-bg: #111827;      
            --input-bg: #374151;        
            --progress-bar-bg: #4b5563; 
            --reset-bg: #4b5563;        

            /* Customizable Accent Color - Loaded by JS */
            --accent-color: #4f46e5;    
            --accent-color-rgb: 79, 70, 229;
            
            --timer-font: 'Inter', sans-serif;
        }
        
        body {
            font-family: var(--timer-font);
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .timer-display, #current-time-display {
            font-family: var(--timer-font);
            transition: color 0.3s, background-color 0.3s;
            font-variant-numeric: tabular-nums; 
            font-feature-settings: "tnum";
        }

        /* --- MODAL OVERLAY STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 50;
            display: none; 
            place-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            max-width: 90vw;
            width: 450px; /* Slightly wider for settings */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Specific Alert Modal */
        #eventAlertModal .modal-content {
             border: 4px solid #f97316; /* Orange border */
             box-shadow: 0 0 40px rgba(249, 115, 22, 0.8); /* Orange glow */
        }
        
        .tab-button.active {
            border-bottom: 3px solid var(--accent-color);
            color: var(--text-color);
            font-weight: 700;
        }


        /* --- PULSATING ALERT ANIMATION --- */
        @keyframes pulse-alert {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 0 30px rgba(255, 0, 0, 0.9);
            }
            50% {
                transform: scale(1.01);
                opacity: 0.9;
                box-shadow: 0 0 50px rgba(255, 0, 0, 1.2);
            }
        }

        .alert-active {
            color: #fee2e2 !important; 
            background-color: #dc2626 !important; 
            font-weight: 900; 
            animation: pulse-alert 1s infinite alternate; 
        }
        
        /* FONT SIZE ADAPTATION */
        .timer-display {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(3rem, 18vmin, 8rem); 
            font-weight: 900;
            cursor: pointer; 
            padding-left: 0.5rem; 
            padding-right: 0.5rem;
            min-height: 8rem; 
        }
        
        .control-button {
            width: 3.5rem; 
            height: 3.5rem; 
            border-radius: 0.75rem; 
            font-size: 0.875rem; 
            font-weight: 700; 
            transition: all 0.15s; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-input-field, .text-input-field {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 2px solid transparent;
            font-weight: 700;
            font-size: 1.5rem;
            padding: 0.5rem 0.25rem;
            text-align: center;
            width: 4.5rem; 
            transition: border-color 0.2s;
        }
        .text-input-field {
            font-size: 1rem;
            padding: 0.75rem;
            width: 100%;
            text-align: left;
        }
        .text-input-field:focus, .time-input-field:focus {
            border-color: var(--accent-color); 
            outline: none;
        }

        /* Style for the Accent Color Picker */
        #color-picker {
            width: 100%;
            height: 50px;
            border: none;
            cursor: pointer;
            border-radius: 0.5rem;
            padding: 0;
            transition: transform 0.1s;
        }
        #color-picker:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<!-- The body class is set to fill the screen and center the content -->
<body class="h-full w-full flex items-center justify-center p-4">

    <!-- App container now utilizes Tailwind's responsiveness for layout change -->
    <div id="app-container" 
         class="w-full h-full flex flex-col sm:p-2 lg:p-4 lg:gap-6 relative" 
         style="max-width: 1200px;"> 
        
        <!-- Header is full width -->
        <header id="header-section" class="flex justify-between items-center p-3 rounded-xl shadow-xl lg:px-6 lg:py-4"
                style="background-color: var(--card-bg); color: var(--text-color);">
            <h1 class="text-xl font-extrabold lg:text-2xl">GeeClock</h1>
            
            <div class="flex items-center space-x-4">
                <!-- Settings Button - Opens the main settings modal -->
                <button onclick="showSettingsModal('color')" 
                        class="p-2 rounded-full hover:bg-gray-700 transition duration-150 text-gray-400 hover:text-white"
                        title="General Settings">
                    <svg class="w-6 h-6 lg:w-7 lg:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>

                <!-- Current Time Display -->
                <div id="current-time-display" class="text-sm text-right">
                    <div class="flex items-end justify-end leading-none">
                        <span id="time-numbers" class="font-bold text-xl lg:text-2xl" style="color: var(--text-color);">--:--:--</span>
                        <span id="time-period" class="text-xs font-semibold ml-1" style="color: var(--sub-text-color);">--</span>
                    </div>
                    <div id="current-date" class="text-xs leading-none lg:text-sm" style="color: var(--sub-text-color);">---</div>
                </div>
            </div>
        </header>
        
        <!-- Main content area: Responsive layout container -->
        <div id="main-content-area" class="flex-grow flex flex-col lg:flex-row lg:items-start lg:gap-6 pt-3">
            
            <!-- Timers list column -->
            <div id="timers-column-wrapper" class="flex-grow w-full lg:max-w-md xl:max-w-lg flex flex-col">
                <div id="timers-container" class="space-y-4 w-full p-1 overflow-y-auto flex-grow" style="max-height: 100%;"> 
                    <div id="loading-message" class="text-center p-4 rounded-xl" style="background-color: var(--input-bg); color: var(--text-color);">Loading clocks...</div>
                </div>
            </div>

            <!-- Add Button Area -->
            <div id="add-button-area" class="flex justify-center pt-2 pb-2 lg:order-last lg:self-start lg:w-full lg:max-w-md xl:max-w-lg">
                <button onclick="addTimer(true)" 
                        class="p-3 rounded-full hover:shadow-2xl text-white transition duration-150 shadow-xl transform hover:scale-105"
                        style="background-color: var(--accent-color); box-shadow: 0 10px 20px -5px rgba(var(--accent-color-rgb), 0.5);">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </button>
            </div>
            
            <!-- Spacer/Placeholder for large screens -->
            <div class="hidden lg:block lg:flex-grow">
                <div class="text-lg font-semibold p-4 text-center" style="color: var(--sub-text-color);">
                    Timer List
                </div>
            </div>

        </div>

    </div>

    <!-- Modal for setting time -->
    <div id="setTimeModal" class="modal-overlay" onclick="if(event.target.id === 'setTimeModal') hideSetTimeModal()">
        <div class="modal-content space-y-6" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-center">Set Timer Limit</h2>
            <p class="text-center text-sm" style="color: var(--sub-text-color);">Set all values to 0 for count-up mode.</p>

            <div class="flex justify-center items-center gap-4 text-center">
                <div class="flex flex-col items-center">
                    <input type="number" id="modal-hr" min="0" placeholder="00" class="time-input-field rounded-lg">
                    <span class="text-xs mt-1" style="color: var(--sub-text-color);">Hours</span>
                </div>
                <div class="text-2xl font-bold">:</div>
                <div class="flex flex-col items-center">
                    <input type="number" id="modal-min" min="0" max="59" placeholder="00" class="time-input-field rounded-lg">
                    <span class="text-xs mt-1" style="color: var(--sub-text-color);">Minutes</span>
                </div>
                <div class="text-2xl font-bold">:</div>
                <div class="flex flex-col items-center">
                    <input type="number" id="modal-sec" min="0" max="59" placeholder="00" class="time-input-field rounded-lg">
                    <span class="text-xs mt-1" style="color: var(--sub-text-color);">Seconds</span>
                </div>
            </div>

            <div class="flex justify-around pt-4">
                <button onclick="applyTimeSettings()" 
                        class="py-3 px-8 rounded-full text-white font-bold transition duration-150 shadow-lg transform hover:scale-105"
                        style="background-color: var(--accent-color); box-shadow: 0 5px 15px -5px rgba(var(--accent-color-rgb), 0.7);">
                    Set Time
                </button>
                <button onclick="hideSetTimeModal()" class="py-3 px-8 rounded-full bg-gray-500 hover:bg-gray-600 text-white font-bold transition duration-150 shadow-lg shadow-gray-500/50">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Main Settings Modal (Color and Calendar Tabs) -->
    <div id="settingsModal" class="modal-overlay" onclick="if(event.target.id === 'settingsModal') hideSettingsModal()">
        <div class="modal-content space-y-6" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-center">App Settings</h2>

            <!-- Tabs -->
            <div class="flex border-b border-gray-700">
                <button id="tab-color" onclick="changeSettingTab('color')" class="tab-button px-4 py-2 text-sm text-gray-400 hover:text-white transition duration-150">Color</button>
                <button id="tab-calendar" onclick="changeSettingTab('calendar')" class="tab-button px-4 py-2 text-sm text-gray-400 hover:text-white transition duration-150">Calendar</button>
            </div>

            <!-- Tab Content: Color -->
            <div id="content-color" class="setting-content space-y-4">
                <p class="text-center text-sm" style="color: var(--sub-text-color);">Choose your accent color for the timers and controls.</p>
                <div class="flex flex-col items-center gap-4">
                    <label for="color-picker" class="text-lg font-medium">Accent Color Preview:</label>
                    <input type="color" id="color-picker" value="#4f46e5" title="Pick an Accent Color">
                </div>
                <div class="flex justify-end pt-4">
                    <button onclick="applyColorSettings()" 
                            class="py-3 px-8 rounded-full text-white font-bold transition duration-150 shadow-lg transform hover:scale-105"
                            style="background-color: var(--accent-color); box-shadow: 0 5px 15px -5px rgba(var(--accent-color-rgb), 0.7);">
                        Apply & Save Color
                    </button>
                </div>
            </div>

            <!-- Tab Content: Calendar -->
            <div id="content-calendar" class="setting-content space-y-4 hidden">
                <p class="text-sm" style="color: var(--sub-text-color);">
                    Enter the public **iCalendar (.ics) link** from your Google Calendar. This allows the app to fetch events and provide 5-minute pre-event alerts.
                </p>
                <div class="flex flex-col items-start gap-2">
                    <label for="calendar-url" class="text-sm font-medium">iCalendar (.ics) URL:</label>
                    <input type="url" id="calendar-url" placeholder="https://calendar.google.com/calendar/ical/..." class="text-input-field rounded-lg">
                    <p id="fetch-status" class="text-xs text-red-400">Status: Not configured.</p>
                </div>
                <div class="flex justify-end pt-4">
                    <button onclick="applyCalendarSettings()" 
                            class="py-3 px-8 rounded-full text-white font-bold transition duration-150 shadow-lg transform hover:scale-105"
                            style="background-color: var(--accent-color); box-shadow: 0 5px 15px -5px rgba(var(--accent-color-rgb), 0.7);">
                        Apply & Start Checking
                    </button>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Event Alert Modal -->
    <div id="eventAlertModal" class="modal-overlay" onclick="if(event.target.id === 'eventAlertModal') hideEventAlertModal()">
        <div class="modal-content space-y-4 text-center" onclick="event.stopPropagation()">
            <h2 class="text-3xl font-extrabold text-orange-400">Upcoming Event!</h2>
            <div class="text-xl font-bold p-3 rounded-lg" id="event-alert-message">
                It will be 5 minutes to go before [Event Name].
            </div>
            <p class="text-sm" style="color: var(--sub-text-color);">This alert will automatically dismiss after the event starts.</p>
            <button onclick="hideEventAlertModal()" 
                    class="py-2 px-6 rounded-full text-white font-bold bg-orange-600 hover:bg-orange-700 transition duration-150 shadow-lg transform hover:scale-105">
                Dismiss
            </button>
        </div>
    </div>
    
    <script>
        // --- Global State & Constants ---
        const DEFAULT_MAX_SECONDS = 0;
        const LOCAL_STORAGE_KEY = 'geeVitalityTimers';
        const COLOR_STORAGE_KEY = 'geeVitalityAccentColor';
        const CALENDAR_URL_KEY = 'geeVitalityCalendarUrl';
        const DEFAULT_COLOR = '#4f46e5'; 
        
        // --- FIX: Updated CORS Proxy to a more reliable service ---
        const CORS_PROXY = 'https://corsproxy.io/?'; 

        const START_COLOR_CLASSES = 'bg-green-600 hover:bg-green-700 shadow-green-500/50';
        const STOP_COLOR_CLASSES = 'bg-red-600 hover:bg-red-700 shadow-red-500/50';

        let timerCounter = 0; 
        let wakeLock = null;
        let synth = null;
        let isToneInitialized = false;
        let currentEditingChatId = null;
        
        let chatStates = {}; 
        let calendarUrl = '';
        let calendarEvents = [];
        let isAlertActive = false; // Prevents spamming alerts
        let calendarIntervalId = null;
        
        // --- PRODUCTION ALERT CONSTANT ---
        // Alert will trigger 5 minutes before the event starts.
        const ALERT_PRE_TIME_MS = 5 * 60 * 1000; 
        // ---------------------------------

        // --- Color Utility Function ---
        
        function hexToRgbString(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });

            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '79, 70, 229'; 
        }

        function applyColor(color) {
            const root = document.documentElement;
            root.style.setProperty('--accent-color', color);
            root.style.setProperty('--accent-color-rgb', hexToRgbString(color)); 
        }

        // --- Persistence (LocalStorage) Functions ---
        
        function saveStateToLocalStorage() {
            try {
                const stateToSave = {};
                for (const id in chatStates) {
                    const state = chatStates[id];
                    stateToSave[id] = {
                        seconds: state.seconds, 
                        maxSeconds: state.maxSeconds, 
                        alertTriggered: state.alertTriggered,
                        isRunning: state.isRunning, 
                    };
                }
                
                const data = {
                    chatStates: stateToSave,
                    timerCounter: timerCounter
                };
                
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
                localStorage.setItem(CALENDAR_URL_KEY, calendarUrl); // Save calendar URL
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
            }
        }
        
        function loadStateFromLocalStorage() {
            const loadingMessage = document.getElementById('loading-message');
            loadingMessage.textContent = 'Fetching saved clocks...';

            try {
                // Load Timer States
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                let timersFound = false;

                if (storedData) {
                    const data = JSON.parse(storedData);
                    chatStates = data.chatStates || {};
                    timerCounter = data.timerCounter || 0;
                    
                    if (Object.keys(chatStates).length > 0) {
                        timersFound = true;
                        
                        for (const id in chatStates) {
                            const state = chatStates[id];
                            state.intervalId = null;
                            state.isRunning = state.isRunning || false;
                            
                            const timerNum = parseInt(id.split('-')[1]);
                            const timerHtml = createTimerHTML(id, timerNum, state);
                            document.getElementById('timers-container').insertAdjacentHTML('beforeend', timerHtml);
                            updateStartButtonVisuals(id, state.isRunning);
                            
                            if (state.isRunning) {
                                startTimer(id, false); 
                            } else {
                                updateDisplay(id);
                            }
                        }
                    }
                }
                
                if (!timersFound) {
                    addTimer(false); 
                }
                
                // Load Calendar URL
                calendarUrl = localStorage.getItem(CALENDAR_URL_KEY) || '';
                
                const msg = document.getElementById('loading-message');
                if(msg) msg.remove();
                
            } catch (e) {
                console.error("Error loading state from localStorage:", e);
                const msg = document.getElementById('loading-message');
                if(msg) msg.textContent = 'Local storage load failed. Starting fresh clock.';
                setTimeout(() => { 
                    const msg = document.getElementById('loading-message');
                    if(msg) msg.remove();
                    addTimer(false); 
                }, 1000);
            }
        }
        
        // --- App Initialization ---

        function initializeApp() {
            loadColorSetting(); 
            loadStateFromLocalStorage(); 
            requestWakeLock();
            
            setInterval(updateCurrentTime, 1000);
            updateCurrentTime(); 
            
            // Start the calendar checking process
            scheduleCalendarCheck(true);
        }

        // --- Tone.js Audio Functions ---

        function initTone() {
            if (isToneInitialized) return;
            try {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                synth = new Tone.Synth().toDestination(); 
                isToneInitialized = true;
            } catch (e) {
                console.error("Failed to initialize Tone.js/AudioContext:", e);
            }
        }

        function playSoundAlert() {
            if (synth) {
                synth.triggerAttackRelease("C5", "32n", Tone.now());
                synth.triggerAttackRelease("G4", "32n", Tone.now() + 0.1); 
            }
        }
        
        function playCalendarAlert() {
            if (synth) {
                synth.triggerAttackRelease("A4", "16n", Tone.now());
                synth.triggerAttackRelease("C5", "16n", Tone.now() + 0.2); 
            }
        }

        // --- Utility Functions ---

        function lerp(start, end, t) {
            return start * (1 - t) + end * t;
        }
        
        function hsl(h, s, l) {
            return `hsl(${Math.round(h)}, ${Math.round(s)}%, ${Math.round(l)}%)`;
        }
        
        async function requestWakeLock() {
            // Wake Lock logic... (omitted for brevity)
        }

        // --- Calendar Parsing and Checking Logic ---
        
        /**
         * Parses the essential components (DTSTART, SUMMARY) from raw iCalendar data.
         * IMPORTANT: Enhanced regex and date handling for better robustness.
         */
        function parseICal(data) {
            const events = [];
            const lines = data.split('\n');
            let currentEvent = null;

            for (const line of lines) {
                const trimmed = line.trim();

                if (trimmed === 'BEGIN:VEVENT') {
                    currentEvent = { summary: 'Unknown Event', start: null, end: null };
                } else if (trimmed === 'END:VEVENT' && currentEvent && currentEvent.start) {
                    events.push(currentEvent);
                    currentEvent = null;
                } else if (currentEvent) {
                    // Extract Summary
                    if (trimmed.startsWith('SUMMARY:')) {
                        currentEvent.summary = trimmed.substring(8).trim();
                    } 
                    // Extract Start Time (Handles DTSTART, DTSTART;TZID=..., and UTC 'Z' suffix)
                    else if (trimmed.startsWith('DTSTART')) {
                        // Regex to grab the YYYYMMDDTHHMMSS part, optionally followed by 'Z'
                        const valueMatch = trimmed.match(/:\s*(\d{8}T\d{6}Z?)/i);
                        
                        if (valueMatch) {
                            const dtString = valueMatch[1];
                            
                            if (dtString.endsWith('Z')) {
                                // UTC time: Convert to ISO 8601 string (YYYY-MM-DDTHH:MM:SSZ) for reliable Date parsing
                                const isoString = `${dtString.substring(0, 4)}-${dtString.substring(4, 6)}-${dtString.substring(6, 8)}T${dtString.substring(9, 11)}:${dtString.substring(11, 13)}:${dtString.substring(13, 15)}Z`;
                                currentEvent.start = new Date(isoString);
                            } else {
                                // Local time (or implied local time): Use manual construction
                                const year = parseInt(dtString.substring(0, 4), 10);
                                const month = parseInt(dtString.substring(4, 6), 10) - 1; 
                                const day = parseInt(dtString.substring(6, 8), 10);
                                const hour = parseInt(dtString.substring(9, 11), 10);
                                const minute = parseInt(dtString.substring(11, 13), 10);
                                const second = parseInt(dtString.substring(13, 15), 10);
                                
                                // Create a date object in the local timezone of the user's browser
                                currentEvent.start = new Date(year, month, day, hour, minute, second);
                            }
                            
                            if (isNaN(currentEvent.start.getTime())) {
                                console.warn('iCal Parse Warning: Invalid date parsed for event:', currentEvent.summary, dtString);
                                currentEvent.start = null; // Mark as invalid
                            }
                        }
                    }
                }
            }
            return events;
        }

        /**
         * Fetches and parses the calendar data.
         */
        async function fetchCalendarData() {
            if (!calendarUrl) {
                console.log("Calendar URL not set. Skipping fetch.");
                return;
            }

            const statusEl = document.getElementById('fetch-status');
            if(statusEl) {
                statusEl.textContent = 'Status: Fetching...';
                statusEl.style.color = 'yellow';
            }
            
            try {
                // Use CORS proxy to avoid cross-origin restrictions
                const encodedUrl = encodeURIComponent(calendarUrl);
                // The new proxy format simply appends the encoded target URL after the base.
                const fullProxyUrl = CORS_PROXY + encodedUrl; 
                
                const response = await fetch(fullProxyUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${fullProxyUrl}`);
                }

                const data = await response.text();
                
                if (data.includes('BEGIN:VCALENDAR')) {
                    calendarEvents = parseICal(data);
                } else {
                    throw new Error("Invalid iCal response: Data does not contain VCALENDAR structure.");
                }


                if(statusEl) {
                    statusEl.textContent = `Status: Last fetched ${new Date().toLocaleTimeString()} (${calendarEvents.length} events found).`;
                    statusEl.style.color = 'lime';
                }
                
            } catch (e) {
                console.error("Failed to fetch or parse iCal data. Check the console for the network error.", e);
                if(statusEl) {
                    statusEl.textContent = 'Status: Error fetching calendar data. Check URL/CORS.';
                    statusEl.style.color = 'red';
                }
            }
        }

        /**
         * Checks the calendar events for upcoming alerts.
         */
        function checkEvents() {
            if (calendarEvents.length === 0) return;

            const now = Date.now();
            // Using the production alert window (5 minutes)
            const ALERT_WINDOW = ALERT_PRE_TIME_MS; 

            let upcomingEvent = null;

            for (const event of calendarEvents) {
                if (!event.start) continue;

                const eventTime = event.start.getTime();
                const alertTime = eventTime - ALERT_WINDOW;

                // Check if we are within the alert window (alertTime to eventTime)
                if (now >= alertTime && now < eventTime) {
                    upcomingEvent = event;
                    break;
                }
            }

            if (upcomingEvent && !isAlertActive) {
                showEventAlertModal(upcomingEvent.summary);
                playCalendarAlert();
                isAlertActive = true; 
            } else if (!upcomingEvent && isAlertActive) {
                // If the event window has passed, automatically dismiss the alert
                hideEventAlertModal();
                isAlertActive = false;
            }
            // If an event is upcoming and the modal is active, the alert is handled.
        }

        /**
         * Sets up the two calendar checking intervals:
         * 1. Check Events loop (runs every 10 seconds for real-time alerts)
         * 2. Fetch Data loop (runs every 5 minutes to get fresh data)
         */
        function scheduleCalendarCheck(initialRun = false) {
            if (calendarIntervalId) {
                clearInterval(calendarIntervalId);
            }
            
            // 1. Initial run and immediate check
            if (calendarUrl || initialRun) {
                 fetchCalendarData();
                 checkEvents(); // Run check right after fetch
            } else {
                 calendarEvents = [];
            }
            
            // 2. Schedule Fetch (every 5 minutes)
            setInterval(fetchCalendarData, 5 * 60 * 1000);

            // 3. Schedule Check (every 10 seconds for precise alerting)
            calendarIntervalId = setInterval(checkEvents, 10 * 1000); 
        }

        // --- Settings Modal Functions ---

        /**
         * Main function to show the settings modal with a specific tab active.
         */
        window.showSettingsModal = function(tabName = 'color') {
            const picker = document.getElementById('color-picker');
            picker.value = document.documentElement.style.getPropertyValue('--accent-color') || DEFAULT_COLOR; 
            
            const urlInput = document.getElementById('calendar-url');
            urlInput.value = calendarUrl;
            
            // Update status text on load if URL is present but error occurred
            if (calendarUrl && document.getElementById('fetch-status').textContent.includes('Not configured')) {
                document.getElementById('fetch-status').textContent = 'Status: Ready to fetch...';
                document.getElementById('fetch-status').style.color = 'yellow';
            }


            document.getElementById('settingsModal').style.display = 'grid';
            
            setTimeout(() => {
                document.getElementById('settingsModal').classList.add('active');
                changeSettingTab(tabName);
            }, 10);
        }

        window.hideSettingsModal = function() {
            document.getElementById('settingsModal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('settingsModal').style.display = 'none';
            }, 200); 
        }
        
        window.changeSettingTab = function(tabName) {
            // Hide all content and remove active class from all tabs
            document.querySelectorAll('.setting-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            // Show selected content and set active tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        window.applyColorSettings = function() {
            const newColor = document.getElementById('color-picker').value;
            applyColor(newColor);
            saveColorSetting(newColor);
            
            // Re-render all timer displays to ensure the new color takes effect
            for (const id in chatStates) {
                updateDisplay(id);
            }
            
            hideSettingsModal();
        }

        window.applyCalendarSettings = function() {
            const newUrl = document.getElementById('calendar-url').value.trim();
            calendarUrl = newUrl;
            
            saveStateToLocalStorage(); 
            
            scheduleCalendarCheck(); 

            hideSettingsModal();
        }

        // --- Event Alert Modal Functions ---
        
        function showEventAlertModal(eventName) {
            initTone(); 
            const msgEl = document.getElementById('event-alert-message');
            // Message reflects the production alert window (5 minutes)
            msgEl.innerHTML = `It will be **5 minutes** to go before **${eventName}**.<br><span class='text-sm' style='color: var(--sub-text-color);'>Dismissed automatically after event start.</span>`;
            
            document.getElementById('eventAlertModal').style.display = 'grid';
            setTimeout(() => {
                document.getElementById('eventAlertModal').classList.add('active');
            }, 10);
        }
        
        window.hideEventAlertModal = function() {
            document.getElementById('eventAlertModal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('eventAlertModal').style.display = 'none';
            }, 200);
            isAlertActive = false;
        }

        // --- Color Persistence (Moved to bottom to clean up) ---
        
        function loadColorSetting() {
            try {
                const storedColor = localStorage.getItem(COLOR_STORAGE_KEY);
                const colorToUse = storedColor || DEFAULT_COLOR;
                applyColor(colorToUse);
            } catch (e) {
                console.error("Error loading color setting:", e);
                applyColor(DEFAULT_COLOR);
            }
        }

        function saveColorSetting(color) {
            try {
                localStorage.setItem(COLOR_STORAGE_KEY, color);
            } catch (e) {
                console.error("Error saving color setting:", e);
            }
        }

        // --- Timer Utility Functions (Existing) ---

        function updateCurrentTime() {
             // ... (existing updateCurrentTime logic)
            const now = new Date();
            const timeNumbersElement = document.getElementById('time-numbers');
            const timePeriodElement = document.getElementById('time-period');
            const dateElement = document.getElementById('current-date');
            
            if (timeNumbersElement && timePeriodElement && dateElement) {
                
                const timeOptions = { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: true 
                };
                const formatter = new Intl.DateTimeFormat(undefined, timeOptions);
                const parts = formatter.formatToParts(now);

                let timeNumbers = '';
                let timePeriod = '';
                
                for (const part of parts) {
                    if (part.type === 'dayPeriod') {
                        timePeriod = part.value;
                    } else if (part.type !== 'literal' || part.value.trim() !== '') {
                        timeNumbers += part.value;
                    }
                }

                const dateString = now.toLocaleDateString(undefined, { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });

                const tzOptions = { timeZoneName: 'short' };
                const timezoneFull = now.toLocaleTimeString(undefined, tzOptions);
                const timezoneMatch = timezoneFull.match(/\b([A-Z]{3,}|GMT[+-]\d+)\b/); 
                const timezoneString = timezoneMatch ? timezoneMatch[1] : '';

                const combinedDateString = `${dateString} | ${timezoneString}`.trim();

                timeNumbersElement.textContent = timeNumbers.trim();
                timePeriodElement.textContent = timePeriod;
                dateElement.textContent = combinedDateString;
            }
        }

        function getDisplayTime(elapsedSeconds, maxSeconds) {
            let totalSeconds = maxSeconds - elapsedSeconds;
            const isNegative = totalSeconds < 0;
            const absSeconds = Math.abs(totalSeconds);

            const h = String(Math.floor(absSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((absSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(absSeconds % 60).padStart(2, '0');

            const timeString = `${h}:${m}:${s}`;
            
            const shouldShowHours = (maxSeconds > 0 && Math.floor(maxSeconds / 3600) > 0) || (h !== '00');
            
            if (!shouldShowHours) {
                 return isNegative ? `-${m}:${s}` : `${m}:${s}`;
            }

            return isNegative ? `-${timeString}` : timeString;
        }

        function updateDisplay(chatId) {
            const state = chatStates[chatId];
            if (!state) return; 

            const displayElement = document.getElementById(`display-${chatId}`);
            const progressBar = document.getElementById(`progress-${chatId}`);
            const cardElement = document.getElementById(`card-${chatId}`);
            
            const maxHold = state.maxSeconds; 

            if (!displayElement || !progressBar || !cardElement) return;

            displayElement.textContent = getDisplayTime(state.seconds, maxHold); 

            displayElement.style.color = 'var(--text-color)'; 

            const percentage = maxHold > 0 ? Math.min(100, (state.seconds / maxHold) * 100) : (state.seconds > 0 ? 100 : 0);
            progressBar.style.width = `${percentage}%`;

            const smoothTransition = 'background-color 1s ease-linear, border-color 1s ease-linear, color 1s ease-linear';
            progressBar.style.transition = smoothTransition;
            cardElement.style.transition = smoothTransition;
            displayElement.style.transition = smoothTransition;

            // 1. Countdown Mode (maxHold > 0)
            if (maxHold > 0) {
                if (state.seconds >= maxHold) {
                    const redColor = '#dc2626'; 

                    progressBar.style.backgroundColor = redColor; 
                    cardElement.style.borderColor = redColor; 
                    
                    if (state.isRunning) {
                        if (!displayElement.classList.contains('alert-active')) {
                            displayElement.classList.add('alert-active');
                        }

                        if (!state.alertTriggered) {
                            playSoundAlert();
                            state.alertTriggered = true; 
                        }
                    } else {
                        displayElement.classList.remove('alert-active');
                        displayElement.style.backgroundColor = 'var(--display-bg)'; 
                        displayElement.style.boxShadow = `0 0 10px ${redColor}`;
                    }

                } else {
                    const t = state.seconds / maxHold; 

                    const H_START = 120; 
                    const H_END = 30;    
                    
                    const h = lerp(H_START, H_END, t);
                    const countdownBarColor = hsl(h, 90, 50); 
                    
                    progressBar.style.backgroundColor = countdownBarColor;
                    
                    cardElement.style.borderColor = 'var(--accent-color)'; 
                    
                    displayElement.classList.remove('alert-active');
                    displayElement.style.backgroundColor = 'var(--display-bg)'; 
                    displayElement.style.boxShadow = ''; 
                    
                    state.alertTriggered = false; 
                }

            } else { 
                // 2. Count-Up Mode (maxHold = 0)
                progressBar.style.backgroundColor = 'var(--accent-color)'; 
                cardElement.style.borderColor = 'var(--accent-color)'; 
                state.alertTriggered = false; 
                
                displayElement.classList.remove('alert-active');
                displayElement.style.backgroundColor = 'var(--display-bg)'; 
                displayElement.style.boxShadow = ''; 
            }
        }
        
        function updateStartButtonVisuals(chatId, isRunning) {
            const button = document.getElementById(`start-btn-${chatId}`);
            if (!button) return;

            if (isRunning) {
                button.classList.remove(...START_COLOR_CLASSES.split(' '));
                button.classList.add(...STOP_COLOR_CLASSES.split(' '));
                button.textContent = 'STOP';
            } else {
                button.classList.remove(...STOP_COLOR_CLASSES.split(' '));
                button.classList.add(...START_COLOR_CLASSES.split(' '));
                button.textContent = 'START';
            }

            button.classList.add('control-button', 'shadow-lg', 'transform', 'hover:scale-105'); 
        }
        
        // --- Timer Control Functions (Existing) ---
        
        window.startTimer = function(chatId, saveState = true) {
            initTone(); 
            const state = chatStates[chatId];
            if (!state) return;

            if (state.isRunning) {
                pauseTimer(chatId);
            } else {
                state.isRunning = true;
                
                if (state.intervalId) { clearInterval(state.intervalId); } 
                
                state.intervalId = setInterval(() => {
                    state.seconds++;
                    updateDisplay(chatId);
                }, 1000);
                
                if (saveState) {
                    saveStateToLocalStorage();
                }
            }
            
            updateStartButtonVisuals(chatId, state.isRunning);
        }

        function pauseTimer(chatId) {
            const state = chatStates[chatId];
            if (state && state.intervalId) {
                clearInterval(state.intervalId);
                state.intervalId = null;
                state.isRunning = false;
                updateDisplay(chatId); 
                saveStateToLocalStorage(); 
            }
        }

        window.resetTimer = function(chatId) {
            pauseTimer(chatId);
            const state = chatStates[chatId];
            if (state) {
                state.seconds = 0; 
                state.alertTriggered = false; 
                updateDisplay(chatId);
                saveStateToLocalStorage();
            }
            
            updateStartButtonVisuals(chatId, false); 
        }
        
        window.removeTimer = function(chatId) {
            pauseTimer(chatId);
            const cardElement = document.getElementById(`card-${chatId}`);
            if (cardElement) {
                cardElement.remove();
                delete chatStates[chatId];
                saveStateToLocalStorage();
            }
            if (Object.keys(chatStates).length === 0) {
                 addTimer(true);
            }
        }

        // --- Timer Setting Modal Functions (Existing) ---

        window.showSetTimeModal = function(chatId) {
            const state = chatStates[chatId];
            if (!state) return;

            currentEditingChatId = chatId;
            
            const initialMaxSeconds = state.maxSeconds || DEFAULT_MAX_SECONDS;
            
            const hours = Math.floor(initialMaxSeconds / 3600);
            const remainingSecondsAfterHours = initialMaxSeconds % 3600;
            const minutes = Math.floor(remainingSecondsAfterHours / 60);
            const seconds = remainingSecondsAfterHours % 60;

            const hrInput = document.getElementById('modal-hr');
            const minInput = document.getElementById('modal-min');
            const secInput = document.getElementById('modal-sec');

            hrInput.value = hours > 0 ? hours : '';
            minInput.value = minutes > 0 ? minutes : '';
            secInput.value = seconds > 0 ? seconds : '';
            
            document.getElementById('setTimeModal').style.display = 'grid';
            
            setTimeout(() => {
                document.getElementById('setTimeModal').classList.add('active');
            }, 10);
            
            if (hours === 0) {
                hrInput.focus();
            } else if (minutes === 0) {
                 minInput.focus();
            } else {
                 secInput.focus();
            }
        }

        window.hideSetTimeModal = function() {
            document.getElementById('setTimeModal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('setTimeModal').style.display = 'none';
                currentEditingChatId = null;
            }, 200); 
        }

        window.applyTimeSettings = function() {
            if (!currentEditingChatId) {
                hideSetTimeModal();
                return;
            }

            const state = chatStates[currentEditingChatId];
            if (!state) {
                hideSetTimeModal();
                return;
            }

            const hours = parseInt(document.getElementById('modal-hr').value || '0', 10);
            const minutes = parseInt(document.getElementById('modal-min').value || '0', 10);
            const seconds = parseInt(document.getElementById('modal-sec').value || '0', 10);

            let totalSeconds = (Math.max(0, hours) * 3600) + 
                             (Math.max(0, minutes) * 60) + 
                             Math.max(0, seconds);
                             
            if (state.maxSeconds > 0 && totalSeconds < state.seconds) {
                 state.seconds = 0;
            }

            state.maxSeconds = totalSeconds;
            
            if (totalSeconds === 0) {
                 state.alertTriggered = false;
            }

            updateDisplay(currentEditingChatId);
            saveStateToLocalStorage();
            
            hideSetTimeModal();
        }


        /**
         * Generates the HTML for a single timer card.
         */
        function createTimerHTML(id, timerNumber, state = chatStates[id]) {
            const initialMaxSeconds = state.maxSeconds || DEFAULT_MAX_SECONDS;
            const initialDisplayTime = getDisplayTime(state.seconds || 0, initialMaxSeconds);
            
            const buttonPlaceholderClass = state.isRunning ? 
                STOP_COLOR_CLASSES : 
                START_COLOR_CLASSES;


            return `
                <div id="card-${id}" class="relative p-5 rounded-xl shadow-2xl border-2 border-gray-700" style="background-color: var(--card-bg);">
                    
                    <div class="w-full"> 
                        <div id="display-${id}" 
                            onclick="showSetTimeModal('${id}')"
                            class="timer-display py-6 rounded-lg shadow-inner overflow-hidden select-none" 
                            style="background-color: var(--display-bg); color: var(--text-color);">
                            ${initialDisplayTime}
                        </div>

                        <div class="h-2 rounded-full overflow-hidden mt-3" style="background-color: var(--progress-bar-bg);">
                            <div id="progress-${id}" class="h-full transition-all duration-1000 ease-linear" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div class="pt-5 flex justify-between items-center">
                        
                        <button onclick="removeTimer('${id}')" 
                                class="p-2 text-sm rounded-lg text-gray-500 hover:text-red-500 transition transform hover:scale-105 flex items-center space-x-1">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>

                        <div class="flex items-center gap-3">
                            
                            <button id="start-btn-${id}" onclick="startTimer('${id}')" 
                                class="control-button text-white uppercase transition duration-150 shadow-lg transform hover:scale-105 ${buttonPlaceholderClass}">
                                </button>

                            <button onclick="resetTimer('${id}')" 
                                class="control-button text-white uppercase transition duration-150 shadow-lg hover:shadow-gray-500/50 transform hover:scale-105" 
                                style="background-color: var(--reset-bg);">
                                RESET
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Adds a new timer card to the UI and initializes its state.
         */
        window.addTimer = function(saveState = true) {
            timerCounter++;
            const newId = 'timer-' + timerCounter;
            
            chatStates[newId] = { 
                seconds: 0, 
                intervalId: null, 
                isRunning: false, 
                alertTriggered: false,
                maxSeconds: DEFAULT_MAX_SECONDS,
            };
            
            const timerHtml = createTimerHTML(newId, timerCounter);
            const container = document.getElementById('timers-container');
            container.insertAdjacentHTML('beforeend', timerHtml);
            
            updateStartButtonVisuals(newId, false);

            if (saveState) {
                saveStateToLocalStorage();
            }

            updateDisplay(newId);
        }

        // Initialize the app display when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp(); 
        });
    </script>
</body>
</html>
